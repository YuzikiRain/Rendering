全局光照中的环境光是为了体现间接光照的，不是直接光照造成的阴影，而是光的散射。

简单的环境光只是为物体增加了一个整体的颜色，不能表现出物体的空间感。

环境光遮蔽：描绘物体和物体相交或靠近的时候遮挡周围漫反射光线的效果，可以解决或改善漏光、飘和阴影不实等问题，解决或改善场景中缝隙、褶皱与墙角、角线以及细小物体等的表现不清晰问题，综合改善细节尤其是暗部阴影，增强空间的层次感、真实感，同时加强和改善画面明暗对比，增强画面的艺术性。

## 思想

考虑片元的可见性（不论光线从哪个方向进来出去）。如果仅有某些方向可见，就认为其受到了一定的遮蔽，接收到的间接光照会更少，表现会更暗。一般通过朝着所有方向随机发射射线（蒙特卡洛法），考察被遮挡射线的比例。$遮蔽率=射线被遮挡的数量/射线总数$，$可见率=1-遮蔽率$

<img src="https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/image-20230104103941428.png" style="zoom:50%" />

## 计算

一般从物体空间或屏幕空间来计算。

### object space

基于光线追踪：对于模型上的每一个点（纹素，对应展开uv到纹理上的像素点），向法线方向所在的半球发射射线，如果碰到任何其他三角形，则认为被遮挡了。

一般只能用于离线渲染，因为计算量大。

为了能实时渲染，一般将这些信息烘焙到AO纹理中使用。缺点是占用内存大。

### SSAO

只关心屏幕内的信息，使用屏幕内的信息还原几何信息。

原理和shadowmap、延迟渲染类似，从深度图中对每一个像素使用**球**去近似计算，在球内使用多个随机位置进行采样。将采样点的深度（NDC空间下的z）与对应深度图中的深度（NDC空间的范围为$[-1,1]$的xy分量转为范围为$[0,1]$的uv再进行采样），如果深度更大（距离相机越远），说明被挡住了，计入该像素的AO贡献度。

![image-20230104114203556](https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/image-20230104114203556.png)

### HBAO（Horizon based ambient occlusion）

SSAO的缺点：如果球半径足够小，理论上应该会有超过一半的采样点是一定会遮挡住的，这些点就是物体内部的点（法线反方向）。因此要减去0.5才是最终结果。这些点的计算实际上是不必要的。

HBAO就是在SSAO的基础上的一种改良：只计算法线方向那边的**半球**而不是整个球。

额外使用了屏幕空间法线信息。